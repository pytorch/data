


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DataPipe Tutorial &mdash; TorchData main documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="DataLoader2 Tutorial" href="dlv2_tutorial.html" />
    <link rel="prev" title="replace_dp" href="generated/torchdata.dataloader2.graph.replace_dp.html" />
  <!-- Google Analytics -->
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-117752657-2');
    </script>
  
  <!-- End Google Analytics -->
  

  
  <script src="_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/data/versions.html'>main (0.7.0a0+1472157 ) &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="torchdata.datapipes.iter.html">Iterable-style DataPipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="torchdata.datapipes.map.html">Map-style DataPipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="torchdata.datapipes.utils.html">Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataloader2.html">DataLoader2</a></li>
<li class="toctree-l1"><a class="reference internal" href="reading_service.html">ReadingService</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial and Examples:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">DataPipe Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="dlv2_tutorial.html">DataLoader2 Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PyTorch Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/docs">PyTorch</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/elastic/">TorchElastic</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>DataPipe Tutorial</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="_sources/dp_tutorial.rst.txt" rel="nofollow"><img src="_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <section id="datapipe-tutorial">
<h1>DataPipe Tutorial<a class="headerlink" href="#datapipe-tutorial" title="Permalink to this heading">¶</a></h1>
<section id="using-datapipes">
<h2>Using DataPipes<a class="headerlink" href="#using-datapipes" title="Permalink to this heading">¶</a></h2>
<p>Suppose that we want to load data from CSV files with the following steps:</p>
<ul class="simple">
<li><p>List all CSV files in a directory</p></li>
<li><p>Load CSV files</p></li>
<li><p>Parse CSV file and yield rows</p></li>
<li><p>Split our dataset into training and validation sets</p></li>
</ul>
<p>There are a few <a class="reference external" href="torchdata.datapipes.iter.html">built-in DataPipes</a> that can help us with the above operations.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FileLister</span></code> - <a class="reference external" href="generated/torchdata.datapipes.iter.FileLister.html">lists out files in a directory</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Filter</span></code> - <a class="reference external" href="generated/torchdata.datapipes.iter.Filter.html">filters the elements in DataPipe based on a given
function</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FileOpener</span></code> - <a class="reference external" href="generated/torchdata.datapipes.iter.FileOpener.html">consumes file paths and returns opened file
streams</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CSVParser</span></code> - <a class="reference external" href="generated/torchdata.datapipes.iter.CSVParser.html">consumes file streams, parses the CSV contents, and returns one parsed line at a
time</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RandomSplitter</span></code> - <a class="reference external" href="generated/torchdata.datapipes.iter.RandomSplitter.html">randomly split samples from a source DataPipe into
groups</a></p></li>
</ul>
<p>As an example, the source code for <code class="docutils literal notranslate"><span class="pre">CSVParser</span></code> looks something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@functional_datapipe</span><span class="p">(</span><span class="s2">&quot;parse_csv&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CSVParserIterDataPipe</span><span class="p">(</span><span class="n">IterDataPipe</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="o">**</span><span class="n">fmtparams</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">=</span> <span class="n">dp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmtparams</span> <span class="o">=</span> <span class="n">fmtparams</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Str_Or_Bytes</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Str_Or_Bytes</span><span class="p">]]]:</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_datapipe</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">skip_lines</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">strip_newline</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_helper</span><span class="o">.</span><span class="n">return_path</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># Returns 1 line at a time as List[str or bytes]</span>
</pre></div>
</div>
<p>As mentioned in a different section, DataPipes can be invoked using their functional forms (recommended) or their
class constructors. A pipeline can be assembled as the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torchdata.datapipes</span> <span class="k">as</span> <span class="nn">dp</span>

<span class="n">FOLDER</span> <span class="o">=</span> <span class="s1">&#39;path/2/csv/folder&#39;</span>
<span class="n">datapipe</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">FileLister</span><span class="p">([</span><span class="n">FOLDER</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">filename</span><span class="p">:</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">))</span>
<span class="n">datapipe</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">FileOpener</span><span class="p">(</span><span class="n">datapipe</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rt&#39;</span><span class="p">)</span>
<span class="n">datapipe</span> <span class="o">=</span> <span class="n">datapipe</span><span class="o">.</span><span class="n">parse_csv</span><span class="p">(</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="n">N_ROWS</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># total number of rows of data</span>
<span class="n">train</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">datapipe</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">total_length</span><span class="o">=</span><span class="n">N_ROWS</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">train</span><span class="p">:</span>  <span class="c1"># Iterating through the training dataset</span>
    <span class="k">pass</span>

<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>  <span class="c1"># Iterating through the validation dataset</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>You can find the full list of built-in <a class="reference external" href="torchdata.datapipes.iter.html">IterDataPipes here</a> and
<a class="reference external" href="torchdata.datapipes.map.html">MapDataPipes here</a>.</p>
</section>
<section id="working-with-dataloader">
<h2>Working with DataLoader<a class="headerlink" href="#working-with-dataloader" title="Permalink to this heading">¶</a></h2>
<p>In this section, we will demonstrate how you can use <code class="docutils literal notranslate"><span class="pre">DataPipe</span></code> with <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>.
For the most part, you should be able to use it just by passing <code class="docutils literal notranslate"><span class="pre">dataset=datapipe</span></code> as an input argument
into the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>. For detailed documentation related to <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>,
please visit <a class="reference external" href="https://pytorch.org/docs/stable/data.html#single-and-multi-process-data-loading">this PyTorch Core page</a>.</p>
<p>Please refer to <a class="reference internal" href="dlv2_tutorial.html"><span class="doc">this page</span></a> about using <code class="docutils literal notranslate"><span class="pre">DataPipe</span></code> with <code class="docutils literal notranslate"><span class="pre">DataLoader2</span></code>.</p>
<p>For this example, we will first have a helper function that generates some CSV files with random label and data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">generate_csv</span><span class="p">(</span><span class="n">file_label</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">num_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;c</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_features</span><span class="p">)]</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sample_data</span><span class="si">{</span><span class="n">file_label</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">):</span>
        <span class="n">row_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">}</span>
        <span class="n">row_data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we will build our DataPipes to read and parse through the generated CSV files. Note that we prefer to have
pass defined functions to DataPipes rather than lambda functions because the formers are serializable with <cite>pickle</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torchdata.datapipes</span> <span class="k">as</span> <span class="nn">dp</span>

<span class="k">def</span> <span class="nf">filter_for_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;sample_data&quot;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">row_processor</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">build_datapipes</span><span class="p">(</span><span class="n">root_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="n">datapipe</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">FileLister</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="n">datapipe</span> <span class="o">=</span> <span class="n">datapipe</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_fn</span><span class="o">=</span><span class="n">filter_for_data</span><span class="p">)</span>
    <span class="n">datapipe</span> <span class="o">=</span> <span class="n">datapipe</span><span class="o">.</span><span class="n">open_files</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rt&#39;</span><span class="p">)</span>
    <span class="n">datapipe</span> <span class="o">=</span> <span class="n">datapipe</span><span class="o">.</span><span class="n">parse_csv</span><span class="p">(</span><span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">skip_lines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Shuffle will happen as long as you do NOT set `shuffle=False` later in the DataLoader</span>
    <span class="n">datapipe</span> <span class="o">=</span> <span class="n">datapipe</span><span class="o">.</span><span class="n">shuffle</span><span class="p">()</span>
    <span class="n">datapipe</span> <span class="o">=</span> <span class="n">datapipe</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">row_processor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datapipe</span>
</pre></div>
</div>
<p>Lastly, we will put everything together in <code class="docutils literal notranslate"><span class="pre">'__main__'</span></code> and pass the DataPipe into the DataLoader. Note that
if you choose to use <code class="docutils literal notranslate"><span class="pre">Batcher</span></code> while setting <code class="docutils literal notranslate"><span class="pre">batch_size</span> <span class="pre">&gt;</span> <span class="pre">1</span></code> for DataLoader, your samples will be
batched more than once. You should choose one or the other.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">num_files_to_generate</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_files_to_generate</span><span class="p">):</span>
        <span class="n">generate_csv</span><span class="p">(</span><span class="n">file_label</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_features</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">datapipe</span> <span class="o">=</span> <span class="n">build_datapipes</span><span class="p">()</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">datapipe</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dl</span><span class="p">))</span>
    <span class="n">labels</span><span class="p">,</span> <span class="n">features</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">first</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Labels batch shape: </span><span class="si">{</span><span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature batch shape: </span><span class="si">{</span><span class="n">features</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">labels</span><span class="w"> </span><span class="si">= }</span><span class="se">\n</span><span class="si">{</span><span class="n">features</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">n_sample</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">dl</span><span class="p">):</span>
        <span class="n">n_sample</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_sample</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The following statements will be printed to show the shapes of a single batch of labels and features.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Labels</span> <span class="n">batch</span> <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">5</span><span class="p">])</span>
<span class="n">Feature</span> <span class="n">batch</span> <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">([[</span><span class="mf">0.2867</span><span class="p">,</span> <span class="mf">0.5973</span><span class="p">,</span> <span class="mf">0.0730</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.7890</span><span class="p">,</span> <span class="mf">0.9279</span><span class="p">,</span> <span class="mf">0.7392</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.8930</span><span class="p">,</span> <span class="mf">0.7434</span><span class="p">,</span> <span class="mf">0.0780</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.8225</span><span class="p">,</span> <span class="mf">0.4047</span><span class="p">,</span> <span class="mf">0.0800</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.1655</span><span class="p">,</span> <span class="mf">0.0323</span><span class="p">,</span> <span class="mf">0.5561</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">n_sample</span> <span class="o">=</span> <span class="mi">12</span>
</pre></div>
</div>
<p>The reason why <code class="docutils literal notranslate"><span class="pre">n_sample</span> <span class="pre">=</span> <span class="pre">12</span></code> is because <code class="docutils literal notranslate"><span class="pre">ShardingFilter</span></code> (<code class="docutils literal notranslate"><span class="pre">datapipe.sharding_filter()</span></code>) was not used, such that
each worker will independently return all samples. In this case, there are 10 rows per file and 3 files, with a
batch size of 5, that gives us 6 batches per worker. With 2 workers, we get 12 total batches from the <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>.</p>
<p>In order for DataPipe sharding to work with <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>, we need to add the following.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_datapipes</span><span class="p">(</span><span class="n">root_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="n">datapipe</span> <span class="o">=</span> <span class="o">...</span>
    <span class="c1"># Add the following line to `build_datapipes`</span>
    <span class="c1"># Note that it is somewhere after `Shuffler` in the DataPipe line, but before expensive operations</span>
    <span class="n">datapipe</span> <span class="o">=</span> <span class="n">datapipe</span><span class="o">.</span><span class="n">sharding_filter</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">datapipe</span>
</pre></div>
</div>
<p>When we re-run, we will get:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">n_sample</span> <span class="o">=</span> <span class="mi">6</span>
</pre></div>
</div>
<p>Note:</p>
<ul class="simple">
<li><p>Place <code class="docutils literal notranslate"><span class="pre">ShardingFilter</span></code> (<code class="docutils literal notranslate"><span class="pre">datapipe.sharding_filter</span></code>) as early as possible in the pipeline, especially before expensive
operations such as decoding, in order to avoid repeating these expensive operations across worker/distributed processes.</p></li>
<li><p>For the data source that needs to be sharded, it is crucial to add <code class="docutils literal notranslate"><span class="pre">Shuffler</span></code> before <code class="docutils literal notranslate"><span class="pre">ShardingFilter</span></code>
to ensure data are globally shuffled before being split into shards. Otherwise, each worker process would
always process the same shard of data for all epochs. And, it means each batch would only consist of data
from the same shard, which leads to low accuracy during training. However, it doesn’t apply to the data
source that has already been sharded for each multi-/distributed process, since <code class="docutils literal notranslate"><span class="pre">ShardingFilter</span></code> is no
longer required to be presented in the pipeline.</p></li>
<li><p>There may be cases where placing <code class="docutils literal notranslate"><span class="pre">Shuffler</span></code> earlier in the pipeline lead to worse performance, because some
operations (e.g. decompression) are faster with sequential reading. In those cases, we recommend decompressing
the files prior to shuffling (potentially prior to any data loading).</p></li>
</ul>
<p>You can find more DataPipe implementation examples for various research domains <a class="reference external" href="examples.html">on this page</a>.</p>
</section>
<section id="implementing-a-custom-datapipe">
<h2>Implementing a Custom DataPipe<a class="headerlink" href="#implementing-a-custom-datapipe" title="Permalink to this heading">¶</a></h2>
<p>Currently, we already have a large number of built-in DataPipes and we expect them to cover most necessary
data processing operations. If none of them supports your need, you can create your own custom DataPipe.</p>
<p>As a guiding example, let us implement an <code class="docutils literal notranslate"><span class="pre">IterDataPipe</span></code> that applies a callable to the input iterator. For
<code class="docutils literal notranslate"><span class="pre">MapDataPipe</span></code>, take a look at the
<a class="reference external" href="https://github.com/pytorch/pytorch/tree/master/torch/utils/data/datapipes/map">map</a>
folder for examples, and follow the steps below for the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method instead of  the <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> method.</p>
<section id="naming">
<h3>Naming<a class="headerlink" href="#naming" title="Permalink to this heading">¶</a></h3>
<p>The naming convention for <code class="docutils literal notranslate"><span class="pre">DataPipe</span></code> is “Operation”-er, followed by <code class="docutils literal notranslate"><span class="pre">IterDataPipe</span></code> or <code class="docutils literal notranslate"><span class="pre">MapDataPipe</span></code>, as each
DataPipe is essentially a container to apply an operation to data yielded from a source <code class="docutils literal notranslate"><span class="pre">DataPipe</span></code>. For succinctness,
we alias to just “Operation-er” in <strong>init</strong> files. For our <code class="docutils literal notranslate"><span class="pre">IterDataPipe</span></code> example, we’ll name the module
<code class="docutils literal notranslate"><span class="pre">MapperIterDataPipe</span></code> and alias it as <code class="docutils literal notranslate"><span class="pre">iter.Mapper</span></code> under <code class="docutils literal notranslate"><span class="pre">torchdata.datapipes</span></code>.</p>
<p>For the functional method name, the naming convention is <code class="docutils literal notranslate"><span class="pre">datapipe.&lt;operation&gt;</span></code>. For instance,
the functional method name of <code class="docutils literal notranslate"><span class="pre">Mapper</span></code> is <code class="docutils literal notranslate"><span class="pre">map</span></code>, such that it can be invoked by <code class="docutils literal notranslate"><span class="pre">datapipe.map(...)</span></code>.</p>
</section>
<section id="constructor">
<h3>Constructor<a class="headerlink" href="#constructor" title="Permalink to this heading">¶</a></h3>
<p>DataSets are now generally constructed as stacks of <code class="docutils literal notranslate"><span class="pre">DataPipes</span></code>, so each <code class="docutils literal notranslate"><span class="pre">DataPipe</span></code> typically takes a
source <code class="docutils literal notranslate"><span class="pre">DataPipe</span></code> as its first argument. Here is a simplified version of <cite>Mapper</cite> as an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterDataPipe</span>

<span class="k">class</span> <span class="nc">MapperIterDataPipe</span><span class="p">(</span><span class="n">IterDataPipe</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_dp</span><span class="p">:</span> <span class="n">IterDataPipe</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_dp</span> <span class="o">=</span> <span class="n">source_dp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>
</pre></div>
</div>
<p>Note:</p>
<ul class="simple">
<li><p>Avoid loading data from the source DataPipe in <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function, in order to support lazy data loading and save
memory.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">IterDataPipe</span></code> instance holds data in memory, please be ware of the in-place modification of data. When second
iterator is created from the instance, the data may have already changed. Please take <code class="docutils literal notranslate"><span class="pre">IterableWrapper</span></code>
<a class="reference external" href="https://github.com/pytorch/pytorch/blob/master/torch/utils/data/datapipes/iter/utils.py">class</a>
as reference to <code class="docutils literal notranslate"><span class="pre">deepcopy</span></code> data for each iterator.</p></li>
<li><p>Avoid variables names that are taken by the functional names of existing DataPipes. For instance, <code class="docutils literal notranslate"><span class="pre">.filter</span></code> is
the functional name that can be used to invoke <code class="docutils literal notranslate"><span class="pre">FilterIterDataPipe</span></code>. Having a variable named <code class="docutils literal notranslate"><span class="pre">filter</span></code> inside
another <code class="docutils literal notranslate"><span class="pre">IterDataPipe</span></code> can lead to confusion.</p></li>
</ul>
</section>
<section id="iterator">
<h3>Iterator<a class="headerlink" href="#iterator" title="Permalink to this heading">¶</a></h3>
<p>For <code class="docutils literal notranslate"><span class="pre">IterDataPipes</span></code>, an <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> function is needed to consume data from the source <code class="docutils literal notranslate"><span class="pre">IterDataPipe</span></code> then
apply the operation over the data before <code class="docutils literal notranslate"><span class="pre">yield</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MapperIterDataPipe</span><span class="p">(</span><span class="n">IterDataPipe</span><span class="p">):</span>
    <span class="c1"># ... See __init__() defined above</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="length">
<h3>Length<a class="headerlink" href="#length" title="Permalink to this heading">¶</a></h3>
<p>In many cases, as in our <code class="docutils literal notranslate"><span class="pre">MapperIterDataPipe</span></code> example, the <code class="docutils literal notranslate"><span class="pre">__len__</span></code> method of a DataPipe returns the length of the
source DataPipe.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MapperIterDataPipe</span><span class="p">(</span><span class="n">IterDataPipe</span><span class="p">):</span>
    <span class="c1"># ... See __iter__() defined above</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">)</span>
</pre></div>
</div>
<p>However, note that <code class="docutils literal notranslate"><span class="pre">__len__</span></code> is optional for <code class="docutils literal notranslate"><span class="pre">IterDataPipe</span></code> and often inadvisable. For <code class="docutils literal notranslate"><span class="pre">CSVParserIterDataPipe</span></code>
in the using DataPipes section below, <code class="docutils literal notranslate"><span class="pre">__len__</span></code> is not implemented because the number of rows in each file
is unknown before loading it. In some special cases, <code class="docutils literal notranslate"><span class="pre">__len__</span></code> can be made to either return an integer or raise
an Error depending on the input. In those cases, the Error must be a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> to support Python’s
build-in functions like <code class="docutils literal notranslate"><span class="pre">list(dp)</span></code>.</p>
</section>
<section id="registering-datapipes-with-the-functional-api">
<h3>Registering DataPipes with the functional API<a class="headerlink" href="#registering-datapipes-with-the-functional-api" title="Permalink to this heading">¶</a></h3>
<p>Each DataPipe can be registered to support functional invocation using the decorator <code class="docutils literal notranslate"><span class="pre">functional_datapipe</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@functional_datapipe</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MapperIterDataPipe</span><span class="p">(</span><span class="n">IterDataPipe</span><span class="p">):</span>
   <span class="c1"># ...</span>
</pre></div>
</div>
<p>The stack of DataPipes can then be constructed using their functional forms (recommended) or class constructors:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torchdata.datapipes</span> <span class="k">as</span> <span class="nn">dp</span>

<span class="c1"># Using functional form (recommended)</span>
<span class="n">datapipes1</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">FileOpener</span><span class="p">([</span><span class="s1">&#39;a.file&#39;</span><span class="p">,</span> <span class="s1">&#39;b.file&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">decoder</span><span class="p">)</span><span class="o">.</span><span class="n">shuffle</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># Using class constructors</span>
<span class="n">datapipes2</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">FileOpener</span><span class="p">([</span><span class="s1">&#39;a.file&#39;</span><span class="p">,</span> <span class="s1">&#39;b.file&#39;</span><span class="p">])</span>
<span class="n">datapipes2</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">Mapper</span><span class="p">(</span><span class="n">datapipes2</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">decoder</span><span class="p">)</span>
<span class="n">datapipes2</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">Shuffler</span><span class="p">(</span><span class="n">datapipes2</span><span class="p">)</span>
<span class="n">datapipes2</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">Batcher</span><span class="p">(</span><span class="n">datapipes2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above example, <code class="docutils literal notranslate"><span class="pre">datapipes1</span></code> and <code class="docutils literal notranslate"><span class="pre">datapipes2</span></code> represent the exact same stack of <code class="docutils literal notranslate"><span class="pre">IterDataPipe</span></code>s. We
recommend using the functional form of DataPipes.</p>
</section>
</section>
<section id="working-with-cloud-storage-providers">
<h2>Working with Cloud Storage Providers<a class="headerlink" href="#working-with-cloud-storage-providers" title="Permalink to this heading">¶</a></h2>
<p>In this section, we show examples accessing AWS S3, Google Cloud Storage, and Azure Cloud Storage with built-in <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes.
Although only those two providers are discussed here, with additional libraries, <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes
should allow you to connect with other storage systems as well (<a class="reference external" href="https://filesystem-spec.readthedocs.io/en/latest/api.html#other-known-implementations">list of known
implementations</a>).</p>
<p>Let us know on GitHub if you have a request for support for other cloud storage providers,
or you have code examples to share with the community.</p>
<section id="accessing-aws-s3-with-fsspec-datapipes">
<h3>Accessing AWS S3 with <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes<a class="headerlink" href="#accessing-aws-s3-with-fsspec-datapipes" title="Permalink to this heading">¶</a></h3>
<p>This requires the installation of the libraries <code class="docutils literal notranslate"><span class="pre">fsspec</span></code>
(<a class="reference external" href="https://filesystem-spec.readthedocs.io/en/latest/">documentation</a>) and <code class="docutils literal notranslate"><span class="pre">s3fs</span></code>
(<a class="reference external" href="https://github.com/fsspec/s3fs">s3fs GitHub repo</a>).</p>
<p>You can list out the files within a S3 bucket directory by passing a path that starts
with <code class="docutils literal notranslate"><span class="pre">&quot;s3://BUCKET_NAME&quot;</span></code> to
<a class="reference external" href="generated/torchdata.datapipes.iter.FSSpecFileLister.html">FSSpecFileLister</a> (<code class="docutils literal notranslate"><span class="pre">.list_files_by_fsspec(...)</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterableWrapper</span>

<span class="n">dp</span> <span class="o">=</span> <span class="n">IterableWrapper</span><span class="p">([</span><span class="s2">&quot;s3://BUCKET_NAME&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">list_files_by_fsspec</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also open files using <a class="reference external" href="generated/torchdata.datapipes.iter.FSSpecFileOpener.html">FSSpecFileOpener</a>
(<code class="docutils literal notranslate"><span class="pre">.open_files_by_fsspec(...)</span></code>) and stream them
(if supported by the file format).</p>
<p>Note that you can also provide additional parameters via
the argument <code class="docutils literal notranslate"><span class="pre">kwargs_for_open</span></code>. This can be useful for purposes such as accessing specific
bucket version, which you can do so by passing in <code class="docutils literal notranslate"><span class="pre">{version_id:</span> <span class="pre">'SOMEVERSIONID'}</span></code> (more <a class="reference external" href="https://s3fs.readthedocs.io/en/latest/#bucket-version-awareness">details
about S3 bucket version awareness</a>
by <code class="docutils literal notranslate"><span class="pre">s3fs</span></code>). The supported arguments vary by the (cloud) file system that you are accessing.</p>
<p>In the example below, we are streaming the archive by using
<a class="reference external" href="generated/torchdata.datapipes.iter.TarArchiveLoader.html#">TarArchiveLoader</a> (<code class="docutils literal notranslate"><span class="pre">.load_from_tar(mode=&quot;r|&quot;)</span></code>),
in contrast with the usual <code class="docutils literal notranslate"><span class="pre">mode=&quot;r:&quot;</span></code>. This allows us to begin processing data inside the archive
without downloading the whole archive into memory first.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterableWrapper</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">IterableWrapper</span><span class="p">([</span><span class="s2">&quot;s3://BUCKET_NAME/DIRECTORY/1.tar&quot;</span><span class="p">])</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">open_files_by_fsspec</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">load_from_tar</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r|&quot;</span><span class="p">)</span> <span class="c1"># Streaming version</span>
<span class="c1"># The rest of data processing logic goes here</span>
</pre></div>
</div>
<p>Finally, <a class="reference external" href="generated/torchdata.datapipes.iter.FSSpecSaver.html">FSSpecFileSaver</a>
is also available for writing data to cloud.</p>
</section>
<section id="accessing-google-cloud-storage-gcs-with-fsspec-datapipes">
<h3>Accessing Google Cloud Storage (GCS) with <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes<a class="headerlink" href="#accessing-google-cloud-storage-gcs-with-fsspec-datapipes" title="Permalink to this heading">¶</a></h3>
<p>This requires the installation of the libraries <code class="docutils literal notranslate"><span class="pre">fsspec</span></code>
(<a class="reference external" href="https://filesystem-spec.readthedocs.io/en/latest/">documentation</a>) and <code class="docutils literal notranslate"><span class="pre">gcsfs</span></code>
(<a class="reference external" href="https://github.com/fsspec/gcsfs">gcsfs GitHub repo</a>).</p>
<p>You can list out the files within a GCS bucket directory by specifying a path that starts
with <code class="docutils literal notranslate"><span class="pre">&quot;gcs://BUCKET_NAME&quot;</span></code>. The bucket name in the example below is <code class="docutils literal notranslate"><span class="pre">uspto-pair</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterableWrapper</span>

<span class="n">dp</span> <span class="o">=</span> <span class="n">IterableWrapper</span><span class="p">([</span><span class="s2">&quot;gcs://uspto-pair/&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">list_files_by_fsspec</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dp</span><span class="p">))</span>
<span class="c1"># [&#39;gcs://uspto-pair/applications&#39;, &#39;gcs://uspto-pair/docs&#39;, &#39;gcs://uspto-pair/prosecution-history-docs&#39;]</span>
</pre></div>
</div>
<p>Here is an example of loading a zip file <code class="docutils literal notranslate"><span class="pre">05900035.zip</span></code> from a bucket named <code class="docutils literal notranslate"><span class="pre">uspto-pair</span></code> inside the
directory <code class="docutils literal notranslate"><span class="pre">applications</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterableWrapper</span>

<span class="n">dp</span> <span class="o">=</span> <span class="n">IterableWrapper</span><span class="p">([</span><span class="s2">&quot;gcs://uspto-pair/applications/05900035.zip&quot;</span><span class="p">])</span> \
        <span class="o">.</span><span class="n">open_files_by_fsspec</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">load_from_zip</span><span class="p">()</span>
<span class="c1"># Logic to process those archive files comes after</span>
<span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">filestream</span> <span class="ow">in</span> <span class="n">dp</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filestream</span><span class="p">)</span>
<span class="c1"># gcs:/uspto-pair/applications/05900035.zip/05900035/README.txt, StreamWrapper&lt;...&gt;</span>
<span class="c1"># gcs:/uspto-pair/applications/05900035.zip/05900035/05900035-address_and_attorney_agent.tsv, StreamWrapper&lt;...&gt;</span>
<span class="c1"># gcs:/uspto-pair/applications/05900035.zip/05900035/05900035-application_data.tsv, StreamWrapper&lt;...&gt;</span>
<span class="c1"># gcs:/uspto-pair/applications/05900035.zip/05900035/05900035-continuity_data.tsv, StreamWrapper&lt;...&gt;</span>
<span class="c1"># gcs:/uspto-pair/applications/05900035.zip/05900035/05900035-transaction_history.tsv, StreamWrapper&lt;...&gt;</span>
</pre></div>
</div>
</section>
<section id="accessing-azure-blob-storage-with-fsspec-datapipes">
<h3>Accessing Azure Blob storage with <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes<a class="headerlink" href="#accessing-azure-blob-storage-with-fsspec-datapipes" title="Permalink to this heading">¶</a></h3>
<p>This requires the installation of the libraries <code class="docutils literal notranslate"><span class="pre">fsspec</span></code>
(<a class="reference external" href="https://filesystem-spec.readthedocs.io/en/latest/">documentation</a>) and <code class="docutils literal notranslate"><span class="pre">adlfs</span></code>
(<a class="reference external" href="https://github.com/fsspec/adlfs">adlfs GitHub repo</a>).
You can access data in Azure Data Lake Storage Gen2 by providing URIs staring with <code class="docutils literal notranslate"><span class="pre">abfs://</span></code>.
For example,
<a class="reference external" href="generated/torchdata.datapipes.iter.FSSpecFileLister.html">FSSpecFileLister</a> (<code class="docutils literal notranslate"><span class="pre">.list_files_by_fsspec(...)</span></code>)
can be used to list files in a directory in a container:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterableWrapper</span>

<span class="n">storage_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;account_name&#39;</span><span class="p">:</span> <span class="n">ACCOUNT_NAME</span><span class="p">,</span> <span class="s1">&#39;account_key&#39;</span><span class="p">:</span> <span class="n">ACCOUNT_KEY</span><span class="p">}</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">IterableWrapper</span><span class="p">([</span><span class="s1">&#39;abfs://CONTAINER/DIRECTORY&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">list_files_by_fsspec</span><span class="p">(</span><span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dp</span><span class="p">))</span>
<span class="c1"># [&#39;abfs://container/directory/file1.txt&#39;, &#39;abfs://container/directory/file2.txt&#39;, ...]</span>
</pre></div>
</div>
<p>You can also open files using <a class="reference external" href="generated/torchdata.datapipes.iter.FSSpecFileOpener.html">FSSpecFileOpener</a>
(<code class="docutils literal notranslate"><span class="pre">.open_files_by_fsspec(...)</span></code>) and stream them
(if supported by the file format).</p>
<p>Here is an example of loading a CSV file <code class="docutils literal notranslate"><span class="pre">ecdc_cases.csv</span></code> from a public container inside the
directory <code class="docutils literal notranslate"><span class="pre">curated/covid-19/ecdc_cases/latest</span></code>, belonging to account <code class="docutils literal notranslate"><span class="pre">pandemicdatalake</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterableWrapper</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">IterableWrapper</span><span class="p">([</span><span class="s1">&#39;abfs://public/curated/covid-19/ecdc_cases/latest/ecdc_cases.csv&#39;</span><span class="p">])</span> \
        <span class="o">.</span><span class="n">open_files_by_fsspec</span><span class="p">(</span><span class="n">account_name</span><span class="o">=</span><span class="s1">&#39;pandemicdatalake&#39;</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">parse_csv</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dp</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>
<span class="c1"># [[&#39;date_rep&#39;, &#39;day&#39;, ..., &#39;iso_country&#39;, &#39;daterep&#39;],</span>
<span class="c1"># [&#39;2020-12-14&#39;, &#39;14&#39;, ..., &#39;AF&#39;, &#39;2020-12-14&#39;],</span>
<span class="c1"># [&#39;2020-12-13&#39;, &#39;13&#39;, ..., &#39;AF&#39;, &#39;2020-12-13&#39;]]</span>
</pre></div>
</div>
<p>If necessary, you can also access data in Azure Data Lake Storage Gen1 by using URIs staring with
<code class="docutils literal notranslate"><span class="pre">adl://</span></code> and <code class="docutils literal notranslate"><span class="pre">abfs://</span></code>, as described in <a class="reference external" href="https://github.com/fsspec/adlfs/blob/main/README.md">README of adlfs repo</a></p>
</section>
<section id="accessing-azure-ml-datastores-with-fsspec-datapipes">
<h3>Accessing Azure ML Datastores with <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes<a class="headerlink" href="#accessing-azure-ml-datastores-with-fsspec-datapipes" title="Permalink to this heading">¶</a></h3>
<p>An Azure ML datastore is a <em>reference</em> to an existing storage account on Azure. The key benefits of creating and using an Azure ML datastore are:</p>
<ul class="simple">
<li><p>A common and easy-to-use API to interact with different storage types in Azure (Blob/Files/&lt;datastore&gt;).</p></li>
<li><p>Easier to discover useful datastores when working as a team.</p></li>
<li><p>Authentication is automatically handled - both <em>credential-based</em> access (service principal/SAS/key) and <em>identity-based</em> access (Azure Active Directory/managed identity) are supported. When using credential-based authentication, you do not need to expose secrets in your code.</p></li>
</ul>
<p>This requires the installation of the library <code class="docutils literal notranslate"><span class="pre">azureml-fsspec</span></code>
(<a class="reference external" href="https://learn.microsoft.com/python/api/azureml-fsspec/?view=azure-ml-py">documentation</a>).</p>
<p>You can access data in an Azure ML datastore by providing URIs staring with <code class="docutils literal notranslate"><span class="pre">azureml://</span></code>.
For example,
<a class="reference external" href="generated/torchdata.datapipes.iter.FSSpecFileLister.html">FSSpecFileLister</a> (<code class="docutils literal notranslate"><span class="pre">.list_files_by_fsspec(...)</span></code>)
can be used to list files in a directory in a container:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterableWrapper</span>

<span class="c1"># set the subscription_id, resource_group, and AzureML workspace_name</span>
<span class="n">subscription_id</span> <span class="o">=</span> <span class="s2">&quot;&lt;subscription_id&gt;&quot;</span>
<span class="n">resource_group</span> <span class="o">=</span> <span class="s2">&quot;&lt;resource_group&gt;&quot;</span>
<span class="n">workspace_name</span> <span class="o">=</span> <span class="s2">&quot;&lt;workspace_name&gt;&quot;</span>

<span class="c1"># set the datastore name and path on the datastore</span>
<span class="n">datastore_name</span> <span class="o">=</span> <span class="s2">&quot;&lt;datastore_name&gt;&quot;</span>
<span class="n">path_on_datastore</span> <span class="o">=</span> <span class="s2">&quot;&lt;path_on_datastore&gt;&quot;</span>

<span class="n">uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;azureml://subscriptions/</span><span class="si">{</span><span class="n">subscription_id</span><span class="si">}</span><span class="s2">/resourcegroups/</span><span class="si">{</span><span class="n">resource_group</span><span class="si">}</span><span class="s2">/workspaces/</span><span class="si">{</span><span class="n">workspace_name</span><span class="si">}</span><span class="s2">/datastores/</span><span class="si">{</span><span class="n">datastore_name</span><span class="si">}</span><span class="s2">/paths/</span><span class="si">{</span><span class="n">path_on_datastore</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">dp</span> <span class="o">=</span> <span class="n">IterableWrapper</span><span class="p">([</span><span class="n">uri</span><span class="p">])</span><span class="o">.</span><span class="n">list_files_by_fsspec</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dp</span><span class="p">))</span>
<span class="c1"># [&#39;azureml:///&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/&lt;folder&gt;/file1.txt&#39;,</span>
<span class="c1"># &#39;azureml:///&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/&lt;folder&gt;/file2.txt&#39;, ...]</span>
</pre></div>
</div>
<p>You can also open files using <a class="reference external" href="generated/torchdata.datapipes.iter.FSSpecFileOpener.html">FSSpecFileOpener</a>
(<code class="docutils literal notranslate"><span class="pre">.open_files_by_fsspec(...)</span></code>) and stream them
(if supported by the file format).</p>
<p>Here is an example of loading a tar file from the default Azure ML datastore <code class="docutils literal notranslate"><span class="pre">workspaceblobstore</span></code> where the path is <code class="docutils literal notranslate"><span class="pre">/cifar-10-python.tar.gz</span></code> (top-level folder).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterableWrapper</span>

<span class="c1"># set the subscription_id, resource_group, and AzureML workspace_name</span>
<span class="n">subscription_id</span> <span class="o">=</span> <span class="s2">&quot;&lt;subscription_id&gt;&quot;</span>
<span class="n">resource_group</span> <span class="o">=</span> <span class="s2">&quot;&lt;resource_group&gt;&quot;</span>
<span class="n">workspace_name</span> <span class="o">=</span> <span class="s2">&quot;&lt;workspace_name&gt;&quot;</span>

<span class="c1"># set the datastore name and path on the datastore</span>
<span class="n">datastore_name</span> <span class="o">=</span> <span class="s2">&quot;workspaceblobstore&quot;</span>
<span class="n">path_on_datastore</span> <span class="o">=</span> <span class="s2">&quot;cifar-10-python.tar.gz&quot;</span>

<span class="n">uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;azureml://subscriptions/</span><span class="si">{</span><span class="n">subscription_id</span><span class="si">}</span><span class="s2">/resourcegroups/</span><span class="si">{</span><span class="n">resource_group</span><span class="si">}</span><span class="s2">/workspaces/</span><span class="si">{</span><span class="n">workspace_name</span><span class="si">}</span><span class="s2">/datastores/</span><span class="si">{</span><span class="n">datastore_name</span><span class="si">}</span><span class="s2">/paths/</span><span class="si">{</span><span class="n">path_on_datastore</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">dp</span> <span class="o">=</span> <span class="n">IterableWrapper</span><span class="p">([</span><span class="n">uri</span><span class="p">])</span> \
        <span class="o">.</span><span class="n">open_files_by_fsspec</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">load_from_tar</span><span class="p">()</span>

<span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">filestream</span> <span class="ow">in</span> <span class="n">dp</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c1"># [&#39;azureml:/subscriptions/&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/cifar-10-python.tar.gz/cifar-10-batches-py/data_batch_4&#39;,</span>
<span class="c1">#   &#39;azureml:/subscriptions/&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/cifar-10-python.tar.gz/cifar-10-batches-py/readme.html&#39;,</span>
<span class="c1">#   &#39;azureml:/subscriptions/&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/cifar-10-python.tar.gz/cifar-10-batches-py/test_batch&#39;,</span>
<span class="c1">#   &#39;azureml:/subscriptions/&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/cifar-10-python.tar.gz/cifar-10-batches-py/data_batch_3&#39;,</span>
<span class="c1">#   &#39;azureml:/subscriptions/&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/cifar-10-python.tar.gz/cifar-10-batches-py/batches.meta&#39;,</span>
<span class="c1">#   &#39;azureml:/subscriptions/&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/cifar-10-python.tar.gz/cifar-10-batches-py/data_batch_2&#39;,</span>
<span class="c1">#   &#39;azureml:/subscriptions/&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/cifar-10-python.tar.gz/cifar-10-batches-py/data_batch_5&#39;,</span>
<span class="c1">#   &#39;azureml:/subscriptions/&lt;sub_id&gt;/resourcegroups/&lt;rg_name&gt;/workspaces/&lt;ws_name&gt;/datastores/&lt;datastore&gt;/paths/cifar-10-python.tar.gz/cifar-10-batches-py/data_batch_1]</span>
</pre></div>
</div>
<p>Here is an example of loading a CSV file - the famous Titanic dataset (<a class="reference external" href="https://raw.githubusercontent.com/Azure/azureml-examples/main/cli/assets/data/sample-data/titanic.csv">download</a>) - from the Azure ML datastore <code class="docutils literal notranslate"><span class="pre">workspaceblobstore</span></code> where the path is <code class="docutils literal notranslate"><span class="pre">/titanic.csv</span></code> (top-level folder).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchdata.datapipes.iter</span> <span class="kn">import</span> <span class="n">IterableWrapper</span>

<span class="c1"># set the subscription_id, resource_group, and AzureML workspace_name</span>
<span class="n">subscription_id</span> <span class="o">=</span> <span class="s2">&quot;&lt;subscription_id&gt;&quot;</span>
<span class="n">resource_group</span> <span class="o">=</span> <span class="s2">&quot;&lt;resource_group&gt;&quot;</span>
<span class="n">workspace_name</span> <span class="o">=</span> <span class="s2">&quot;&lt;workspace_name&gt;&quot;</span>

<span class="c1"># set the datastore name and path on the datastore</span>
<span class="n">datastore_name</span> <span class="o">=</span> <span class="s2">&quot;workspaceblobstore&quot;</span>
<span class="n">path_on_datastore</span> <span class="o">=</span> <span class="s2">&quot;titanic.csv&quot;</span>

<span class="n">uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;azureml://subscriptions/</span><span class="si">{</span><span class="n">subscription_id</span><span class="si">}</span><span class="s2">/resourcegroups/</span><span class="si">{</span><span class="n">resource_group</span><span class="si">}</span><span class="s2">/workspaces/</span><span class="si">{</span><span class="n">workspace_name</span><span class="si">}</span><span class="s2">/datastores/</span><span class="si">{</span><span class="n">datastore_name</span><span class="si">}</span><span class="s2">/paths/</span><span class="si">{</span><span class="n">path_on_datastore</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">row_processer</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="c1"># return the label and data (the class and age of the passenger)</span>
    <span class="c1"># if missing age, set to 50</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">50.0</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)}</span>

<span class="n">dp</span> <span class="o">=</span> <span class="n">IterableWrapper</span><span class="p">([</span><span class="n">uri</span><span class="p">])</span> \
        <span class="o">.</span><span class="n">open_files_by_fsspec</span><span class="p">()</span> \
        <span class="o">.</span><span class="n">parse_csv</span><span class="p">(</span><span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">skip_lines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">row_processer</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dp</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>
<span class="c1"># [{&#39;label&#39;: array(0, dtype=int32), &#39;data&#39;: array([ 3., 22.], dtype=float32)},</span>
<span class="c1">#  {&#39;label&#39;: array(1, dtype=int32), &#39;data&#39;: array([ 1., 38.], dtype=float32)},</span>
<span class="c1">#  {&#39;label&#39;: array(1, dtype=int32), &#39;data&#39;: array([ 3., 26.], dtype=float32)}]</span>
</pre></div>
</div>
</section>
</section>
</section>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dlv2_tutorial.html" class="btn btn-neutral float-right" title="DataLoader2 Tutorial" accesskey="n" rel="next">Next <img src="_static/images/chevron-right-orange.svg" class="next-page"></a>
      
      
        <a href="generated/torchdata.dataloader2.graph.replace_dp.html" class="btn btn-neutral" title="replace_dp" accesskey="p" rel="prev"><img src="_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021 - Present, Torch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">DataPipe Tutorial</a><ul>
<li><a class="reference internal" href="#using-datapipes">Using DataPipes</a></li>
<li><a class="reference internal" href="#working-with-dataloader">Working with DataLoader</a></li>
<li><a class="reference internal" href="#implementing-a-custom-datapipe">Implementing a Custom DataPipe</a><ul>
<li><a class="reference internal" href="#naming">Naming</a></li>
<li><a class="reference internal" href="#constructor">Constructor</a></li>
<li><a class="reference internal" href="#iterator">Iterator</a></li>
<li><a class="reference internal" href="#length">Length</a></li>
<li><a class="reference internal" href="#registering-datapipes-with-the-functional-api">Registering DataPipes with the functional API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#working-with-cloud-storage-providers">Working with Cloud Storage Providers</a><ul>
<li><a class="reference internal" href="#accessing-aws-s3-with-fsspec-datapipes">Accessing AWS S3 with <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes</a></li>
<li><a class="reference internal" href="#accessing-google-cloud-storage-gcs-with-fsspec-datapipes">Accessing Google Cloud Storage (GCS) with <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes</a></li>
<li><a class="reference internal" href="#accessing-azure-blob-storage-with-fsspec-datapipes">Accessing Azure Blob storage with <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes</a></li>
<li><a class="reference internal" href="#accessing-azure-ml-datastores-with-fsspec-datapipes">Accessing Azure ML Datastores with <code class="docutils literal notranslate"><span class="pre">fsspec</span></code> DataPipes</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
         <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
         <script src="_static/jquery.js"></script>
         <script src="_static/underscore.js"></script>
         <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="_static/doctools.js"></script>
     

  

  <script type="text/javascript" src="_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>