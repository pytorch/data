


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>What is torchdata.nodes (beta)? &mdash; TorchData 0.10.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="torchdata.nodes (beta)" href="torchdata.nodes.html" />
    <link rel="prev" title="TorchData" href="index.html" />
  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','UA-117752657-2');</script>
    <!-- End Google Tag Manager -->
  

  
  <script src="_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Learn
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/get-started">
                  <span class=dropdown-title>Get Started</span>
                  <p>Run PyTorch locally or get started quickly with one of the supported cloud platforms</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials">
                  <span class="dropdown-title">Tutorials</span>
                  <p>Whats new in PyTorch tutorials</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/basics/intro.html">
                  <span class="dropdown-title">Learn the Basics</span>
                  <p>Familiarize yourself with PyTorch concepts and modules</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/recipes/recipes_index.html">
                  <span class="dropdown-title">PyTorch Recipes</span>
                  <p>Bite-size, ready-to-deploy PyTorch code examples</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/introyt.html">
                  <span class="dropdown-title">Intro to PyTorch - YouTube Series</span>
                  <p>Master PyTorch basics with our engaging YouTube tutorial series</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Ecosystem
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem">
                  <span class="dropdown-title">Tools</span>
                  <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class=dropdown-title>Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class=dropdown-title>Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class=dropdown-title>Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem/contributor-awards-2023">
                  <span class="dropdown-title">Contributor Awards - 2023</span>
                  <p>Award winners announced at this year's PyTorch Conference</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/edge">
                  <span class="dropdown-title">About PyTorch Edge</span>
                  <p>Build innovative and privacy-aware AI experiences for edge devices</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/executorch-overview">
                  <span class="dropdown-title">ExecuTorch</span>
                  <p>End-to-end solution for enabling on-device inference capabilities across mobile and edge devices</p>
                </a>
              </div>
            </div>  
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p>Explore the documentation for comprehensive guidance on how to use PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/pytorch-domains">
                  <span class="dropdown-title">PyTorch Domains</span>
                  <p>Read the PyTorch Domains documentation to learn more about domain-specific libraries</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Blogs & News 
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/blog/">
                  <span class="dropdown-title">PyTorch Blog</span>
                  <p>Catch up on the latest technical news and happenings</p>
                </a>
                 <a class="nav-dropdown-item" href="https://pytorch.org/community-blog">
                  <span class="dropdown-title">Community Blog</span>
                  <p>Stories from the PyTorch ecosystem</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/videos">
                  <span class="dropdown-title">Videos</span>
                  <p>Learn about the latest PyTorch tutorials, new, and more </p>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                About
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn more about the PyTorch Foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/governing-board">
                  <span class="dropdown-title">Governing Board</span>
                  <p></p>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="https://pytorch.org/join" data-cta="join">
                Become a Member
              </a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later. 
          <li>
            <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href='https://pytorch.org/data/versions.html'>0.10.1 &#x25BC</a>
    </div>
    


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Developer Notes:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">What is <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> (beta)?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="torchdata.nodes.html"><code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> (beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="torchdata.stateful_dataloader.html">Stateful DataLoader</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial and Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started_with_torchdata_nodes.html">Getting Started With <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> (beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrate_to_nodes_from_utils.html">Migrating to <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> from <code class="docutils literal notranslate"><span class="pre">torch.utils.data</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="stateful_dataloader_tutorial.html">Stateful DataLoader Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">PyTorch Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/docs">PyTorch</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchtune">torchtune</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/elastic/">TorchElastic</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="http://pytorch.org/xla/">PyTorch on XLA Devices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>What is <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> (beta)?</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="_sources/what_is_torchdata_nodes.rst.txt" rel="nofollow"><img src="_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=UA-117752657-2"
          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="admonition attention">
<p class="admonition-title">Attention</p>
<p><strong>June 2024 Status Update: Removing DataPipes and DataLoader V2</strong></p>
<p>We are re-focusing the torchdata repo to be an iterative enhancement of torch.utils.data.DataLoader. We do not plan on
continuing development or maintaining the [<cite>DataPipes</cite>] and [<cite>DataLoaderV2</cite>] solutions, and they will be removed from
the torchdata repo. We’ll also be revisiting the <cite>DataPipes</cite> references in pytorch/pytorch. In release
<cite>torchdata==0.8.0</cite> (July 2024) they will be marked as deprecated, and in 0.10.0 (Late 2024) they will be deleted. Existing
users are advised to pin to <cite>torchdata&lt;=0.9.0</cite> or an older version until they are able to migrate away. Subsequent
releases will not include DataPipes or DataLoaderV2.
Please reach out if you suggestions or comments (please use <a class="reference external" href="https://github.com/pytorch/data/issues/1196">this issue</a> for feedback)</p>
</div>
<section id="what-is-torchdata-nodes-beta">
<h1>What is <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> (beta)?<a class="headerlink" href="#what-is-torchdata-nodes-beta" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> is a library of composable iterators (not
iterables!) that let you chain together common dataloading and pre-proc
operations. It follows a streaming programming model, although “sampler
+ Map-style” can still be configured if you desire.</p>
<p><code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> adds more flexibility to the standard
<code class="docutils literal notranslate"><span class="pre">torch.utils.data</span></code> offering, and introduces multi-threaded parallelism
in addition to multi-process (the only supported approach in
<code class="docutils literal notranslate"><span class="pre">torch.utils.data.DataLoader</span></code>), as well as first-class support for
mid-epoch checkpointing through a <code class="docutils literal notranslate"><span class="pre">state_dict/load_state_dict</span></code>
interface.</p>
<p><code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> strives to include as many useful operators as
possible, however it’s designed to be extensible. New nodes are required
to subclass <code class="docutils literal notranslate"><span class="pre">torchdata.nodes.BaseNode</span></code>, (which itself subclasses
<code class="docutils literal notranslate"><span class="pre">typing.Iterator</span></code>) and implement <code class="docutils literal notranslate"><span class="pre">next()</span></code>, <code class="docutils literal notranslate"><span class="pre">reset(initial_state)</span></code>
and <code class="docutils literal notranslate"><span class="pre">get_state()</span></code> operations (notably, not <code class="docutils literal notranslate"><span class="pre">__next__</span></code>,
<code class="docutils literal notranslate"><span class="pre">load_state_dict</span></code>, nor <code class="docutils literal notranslate"><span class="pre">state_dict</span></code>)</p>
<p>See <a class="reference internal" href="getting_started_with_torchdata_nodes.html"><span class="doc">Getting Started With torchdata.nodes (beta)</span></a> to get started</p>
<section id="why-torchdata-nodes">
<h2>Why <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code>?<a class="headerlink" href="#why-torchdata-nodes" title="Permalink to this heading">¶</a></h2>
<p>We get it, <code class="docutils literal notranslate"><span class="pre">torch.utils.data</span></code> just works for many many use cases.
However it definitely has a bunch of rough spots:</p>
<section id="multiprocessing-sucks">
<h3>Multiprocessing sucks<a class="headerlink" href="#multiprocessing-sucks" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>You need to duplicate memory stored in your Dataset (because of
Python copy-on-read)</p></li>
<li><p>IPC is slow over multiprocess queues and can introduce slow startup
times</p></li>
<li><p>You’re forced to perform batching on the workers instead of
main-process to reduce IPC overhead, increasing peak memory.</p></li>
<li><p>With GIL-releasing functions and Free-Threaded Python,
multi-threading may not be GIL-bound like it used to be.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> enables both multi-threading and multi-processing so
you can choose what works best for your particular set up. Parallelism
is primarily configured in Mapper operators giving you flexibility in
the what, when, and how to parallelize.</p>
</section>
<section id="map-style-and-random-access-doesnt-scale">
<h3>Map-style and random-access doesn’t scale<a class="headerlink" href="#map-style-and-random-access-doesnt-scale" title="Permalink to this heading">¶</a></h3>
<p>Current map dataset approach is great for datasets that fit in memory,
but true random-access is not going to be very performant once your
dataset grows beyond memory limitations unless you jump through some
hoops with a special sampler.</p>
<p><code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> follows a streaming data model, where operators are
Iterators that can be combined together to define a dataloading and
pre-proc pipeline. Samplers are still supported (see example above) and
can be combined with a Mapper to produce an Iterator</p>
</section>
<section id="multi-datasets-do-not-fit-well-with-the-current-implementation-in-torch-utils-data">
<h3>Multi-Datasets do not fit well with the current implementation in <code class="docutils literal notranslate"><span class="pre">torch.utils.data</span></code><a class="headerlink" href="#multi-datasets-do-not-fit-well-with-the-current-implementation-in-torch-utils-data" title="Permalink to this heading">¶</a></h3>
<p>The current Sampler (one per dataloader) concepts start to break down
when you start trying to combine multiple datasets. (For single
datasets, they’re a great abstraction and will continue to be
supported!)</p>
<ul class="simple">
<li><p>For multi-datasets, consider this scenario: <code class="docutils literal notranslate"><span class="pre">len(dsA):</span> <span class="pre">10</span></code>
<code class="docutils literal notranslate"><span class="pre">len(dsB):</span> <span class="pre">20</span></code>. Now we want to do round-robin (or sample uniformly)
between these two datasets to feed to our trainer. With just a single
sampler, how can you implement that strategy? Maybe a sampler that
emits tuples? What if you want to swap with RandomSampler, or
DistributedSampler? How will <code class="docutils literal notranslate"><span class="pre">sampler.set_epoch</span></code> work?</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> helps to address and scale multi-dataset dataloading
by only dealing with Iterators, thereby forcing samplers and datasets
together, focusing on composing smaller primitives nodes into a more
complex dataloading pipeline.</p>
</section>
<section id="iterabledataset-multiprocessing-requires-additional-dataset-sharding">
<h3>IterableDataset + multiprocessing requires additional dataset sharding<a class="headerlink" href="#iterabledataset-multiprocessing-requires-additional-dataset-sharding" title="Permalink to this heading">¶</a></h3>
<p>Dataset sharding is required for data-parallel training, which is fairly
reasonable. But what about sharding between dataloader workers? With
Map-style datasets, distribution of work between workers is handled by
the main process, which distributes sampler indices to workers. With
IterableDatasets, each worker needs to figure out (through
<code class="docutils literal notranslate"><span class="pre">torch.utils.data.get_worker_info</span></code>) what data it should be returning.</p>
</section>
</section>
<section id="how-does-torchdata-nodes-perform">
<span id="how-does-nodes-perform"></span><h2>How does <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> perform?<a class="headerlink" href="#how-does-torchdata-nodes-perform" title="Permalink to this heading">¶</a></h2>
<p>We presented some results from an early version of <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code>
on a video-decoding benchmark at <a class="reference external" href="https://pytorch2024.sched.com/event/1fHn5/blobs-to-clips-efficient-end-to-end-video-data-loading-andrew-ho-ahmad-sharif-meta">PyTorch Conf 2024</a>
where we showed that:</p>
<ul class="simple">
<li><p>torchdata.nodes performs on-par or better with <code class="docutils literal notranslate"><span class="pre">torch.utils.data.DataLoader</span></code>
when using multi-processing (see <a class="reference internal" href="migrate_to_nodes_from_utils.html#migrate-to-nodes-from-utils"><span class="std std-ref">Migrating to torchdata.nodes from torch.utils.data</span></a>)</p></li>
<li><p>With GIL python, torchdata.nodes with multi-threading performs better than
multi-processing in some scenarios, but makes features like GPU pre-proc
easier to perform which can boost</p></li>
</ul>
<p>We ran a benchmark loading the Imagenet dataset from disk,
and manage to saturate main-memory bandwidth with Free-Threaded Python (3.13t)
at a significantly lower CPU utilization than with multi-process workers
(blogpost expected eary 2025). See <code class="docutils literal notranslate"><span class="pre">examples/nodes/imagenet_benchmark.py</span></code>.</p>
</section>
<section id="design-choices">
<h2>Design choices<a class="headerlink" href="#design-choices" title="Permalink to this heading">¶</a></h2>
<section id="no-generator-basenodes">
<h3>No Generator BaseNodes<a class="headerlink" href="#no-generator-basenodes" title="Permalink to this heading">¶</a></h3>
<p>See <a class="reference external" href="https://github.com/pytorch/data/pull/1362">https://github.com/pytorch/data/pull/1362</a> for more thoughts.</p>
<p>One difficult choice we made was to disallow Generators when defining a
new BaseNode implementation. However we dropped it and moved to an
Iterator-only foundation for a few reasons around state management:</p>
<ol class="arabic simple">
<li><p>We require explicit state handling in BaseNode implementations.
Generators store state implicitly on the stack and we found that we
needed to jump through hoops and write very convoluted code to get
basic state working with Generators</p></li>
<li><p>End-of-iteration state dict: Iterables may feel more natural, however
a bunch of issues come up around state management. Consider the
end-of-iteration state dict. If you load this state_dict into your
iterable, should this represent the end-of-iteration or the start of
the next iteration?</p></li>
<li><p>Loading state: If you call load_state_dict() on an iterable, most
users would expect the next iterator requested from it to start with
the loaded state. However what if iter is called twice before
iteration begins?</p></li>
<li><p>Multiple Live Iterator problem: if you have one instance of an
Iterable, but two live iterators, what does it mean to call
state_dict() on the Iterable? In dataloading, this is very rare,
however we still need to work around it and make a bunch of
assumptions. Forcing devs that are implementing BaseNodes to reason
about these scenarios is, in our opinion, worse than disallowing
generators and Iterables.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">torchdata.nodes.BaseNode</span></code> implementations are Iterators. Iterators
define <code class="docutils literal notranslate"><span class="pre">next()</span></code>, <code class="docutils literal notranslate"><span class="pre">get_state()</span></code>, and <code class="docutils literal notranslate"><span class="pre">reset(initial_state</span> <span class="pre">|</span> <span class="pre">None)</span></code>.
All re-initialization should be done in reset(), including initializing
with a particular state if one is passed.</p>
<p>However, end-users are used to dealing with Iterables, for example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
  <span class="c1"># Most frameworks and users don&#39;t expect to call loader.reset()</span>
  <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
    <span class="o">...</span>
  <span class="n">sd</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
  <span class="c1"># Loading sd should not throw StopIteration right away, but instead start at the next epoch</span>
</pre></div>
</div>
<p>To handle this we keep all of the assumptions and special end-of-epoch
handling in a single <code class="docutils literal notranslate"><span class="pre">Loader</span></code> class which takes any BaseNode and makes
it an Iterable, handling the reset() calls and end-of-epoch state_dict
loading.</p>
</section>
</section>
</section>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="torchdata.nodes.html" class="btn btn-neutral float-right" title="torchdata.nodes (beta)" accesskey="n" rel="next">Next <img src="_static/images/chevron-right-orange.svg" class="next-page"></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="TorchData" accesskey="p" rel="prev"><img src="_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021 - Present, Torch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">What is <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> (beta)?</a><ul>
<li><a class="reference internal" href="#why-torchdata-nodes">Why <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code>?</a><ul>
<li><a class="reference internal" href="#multiprocessing-sucks">Multiprocessing sucks</a></li>
<li><a class="reference internal" href="#map-style-and-random-access-doesnt-scale">Map-style and random-access doesn’t scale</a></li>
<li><a class="reference internal" href="#multi-datasets-do-not-fit-well-with-the-current-implementation-in-torch-utils-data">Multi-Datasets do not fit well with the current implementation in <code class="docutils literal notranslate"><span class="pre">torch.utils.data</span></code></a></li>
<li><a class="reference internal" href="#iterabledataset-multiprocessing-requires-additional-dataset-sharding">IterableDataset + multiprocessing requires additional dataset sharding</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-does-torchdata-nodes-perform">How does <code class="docutils literal notranslate"><span class="pre">torchdata.nodes</span></code> perform?</a></li>
<li><a class="reference internal" href="#design-choices">Design choices</a><ul>
<li><a class="reference internal" href="#no-generator-basenodes">No Generator BaseNodes</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
         <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
         <script src="_static/jquery.js"></script>
         <script src="_static/underscore.js"></script>
         <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="_static/doctools.js"></script>
     

  

  <script type="text/javascript" src="_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="https://www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="https://www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
           <li class="resources-mobile-menu-title">
             <a>Learn</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/get-started">Get Started</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials">Tutorials</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/basics/intro.html">Learn the Basics</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/recipes/recipes_index.html">PyTorch Recipes</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/introyt.html">Introduction to PyTorch - YouTube Series</a>
             </li>
           </ul>
           <li class="resources-mobile-menu-title">
             <a>Ecosystem</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/ecosystem">Tools</a>
             </li>
             <li>
               <a href="https://pytorch.org/#community-module">Community</a>
             </li>
             <li>
               <a href="https://discuss.pytorch.org/">Forums</a>
             </li>
             <li>
               <a href="https://pytorch.org/resources">Developer Resources</a>
             </li>
             <li>
               <a href="https://pytorch.org/ecosystem/contributor-awards-2023">Contributor Awards - 2023</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>Edge</a>
           </li>

           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/edge">About PyTorch Edge</a>
             </li>
             
             <li>
               <a href="https://pytorch.org/executorch-overview">ExecuTorch</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>Docs</a>
           </li>

           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/pytorch-domains">PyTorch Domains</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            <a>Blog & News</a>
          </li>
            
           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/blog/">PyTorch Blog</a>
            </li>
            <li>
              <a href="https://pytorch.org/community-blog">Community Blog</a>
            </li>

            <li>
              <a href="https://pytorch.org/videos">Videos</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>
            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>
          </ul>
          
          <li class="resources-mobile-menu-title">
            <a>About</a>
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>
            <li>
              <a href="https://pytorch.org/governing-board">Governing Board</a>
            </li>
          </ul>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>